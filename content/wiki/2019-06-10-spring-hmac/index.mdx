---
slug: "/2019-06-10/spring-hmac"
updated: 2020-03-09 14:21
title: Springì—ì„œ HMAC-SHA256 ì¸ì¦í•´ë³´ê¸°
date: 2019-06-10
tags: 
    - Java 
    - Auth
---

ì´ë²ˆì— ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ì—°ë™ì„ ì§„í–‰í•˜ë©´ì„œ, ì¸ì¦ì„ *HMAC Signature*ë¡œ í•˜ê²Œ ë˜ì—ˆëŠ”ë°ìš”.

HMACì´ ê°€ë¬¼ê°€ë¬¼í•´ì„œ =) HMACì— ëŒ€í•œ ê°„ëµí•œ ì†Œê°œì™€,
Springì—ì„œ ì–´ë–»ê²Œ requestBodyë¥¼ ë°›ì•„ì™€ì„œ HMAC Signatureë¡œ ë§Œë“œëŠ”ì§€ ìƒ˜í”Œì½”ë“œë¥¼ ì ì–´ë´…ë‹ˆë‹¤.


## HMAC? SHA-256? ì´ê²Œ ë‹¤ ë­ì•¼ ğŸ˜­

HMACì€ í•´ì‹±ê¸°ë²•ì„ ì´ìš©í•´ì„œ ë©”ì‹œì§€ì˜ ìœ„ë³€ì¡°ê°€ ìˆì—ˆëŠ”ì§€ ì²´í¬í•˜ëŠ” ê¸°ë²•ì…ë‹ˆë‹¤.
(Hash-based Message Authentication)

í•´ì‹± ìì²´ëŠ” ì›ë¬¸ ë©”ì‹œì§€ë¥¼ ì¼ì •í•œ ê¸¸ì´ì˜ ë‹¤ë¥¸ ë©”ì‹œì§€ë¡œ ë³€í™˜í•˜ë˜, ì¼ì • ê¸¸ì´ë¡œ ë–¨ì–´ì§€ê²Œ í•˜ëŠ” ê¸°ë²•ì¸ë°ìš”.
ì›ë¬¸ì„ í•´ì‹±í•˜ì—¬ ë‚˜ì˜¨ ë©”ì‹œì§€ë¥¼ **ë‹¤ì´ì œìŠ¤íŠ¸** ë¼ê³  í•©ë‹ˆë‹¤.

í•´ì‹±ì˜ ê²°ê³¼ëŠ” ìœ ì¼í•˜ê³ (ì¦‰, Aë¥¼ ì–¸ì œë“  ê°™ì€ í•´ì‹± ê¸°ë²•ìœ¼ë¡œ ë³€í™˜í•˜ë©´ í•­ìƒ A' ê°€ ëœë‹¤), 
í•´ì‹±ì„ í’€ì–´ ì›ë¬¸ì„ ì°¾ì•„ë‚¼ ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì´ ì¥ì ì…ë‹ˆë‹¤.


ê·¸ëŸ¬ë©´ HMACì„ ì‚¬ìš©í•´ì„œ
ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•  ë•Œ, ìœ„ë³€ì¡°ê°€ ë˜ì—ˆëŠ”ì§€ ì–´ë–»ê²Œ ì•Œ ìˆ˜ ìˆì„ê¹Œìš”?


### HMAC ìœ¼ë¡œ ë©”ì‹œì§€ ìœ„ë³€ì¡° ê°ì§€
1. ë©”ì‹œì§€ ë³´ë‚´ëŠ” ìª½ê³¼ ë°›ëŠ” ìª½ì„ ê°€ì •í•©ë‹ˆë‹¤. 
   ì´ ë‘˜ì€ ë‘ ê°€ì§€ë¥¼ ê³µí†µì ìœ¼ë¡œ ì•Œê³  ìˆì–´ì•¼í•©ë‹ˆë‹¤. 
   **í‚¤** ê·¸ë¦¬ê³  **ì–´ë–¤ HMAC ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš©í• ì§€** ì…ë‹ˆë‹¤. (HMACì˜ ì¢…ë¥˜ê°€ ë‹¤ì–‘í•˜ë¯€ë¡œ)
   ì—¬ê¸°ì„œëŠ” HMAC-SHA256 ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•œë‹¤ê³  í•´ë³´ê² ìŠµë‹ˆë‹¤.
![](../img/2019-06-10/1.png)

<sub><p> hash ëŠ” ì•”í˜¸í™”ëŠ” ì•„ë‹™ë‹ˆë‹¤. ì˜ëª» ì ì—ˆë„¤ìš”!</p> </sub>


2. ë³´ë‚´ëŠ” ìª½ì—ì„œ ë³´ë‚´ê³  ì‹¶ì€ ë‚´ìš©ì´ ìˆê³ , ê·¸ë¦¬ê³  ê³µí†µì˜ KEYê°€ ìˆìŠµë‹ˆë‹¤.
   ì´ë¥¼ ì‚¬ìš©í•´ì„œ ë³´ë‚´ëŠ” ìª½ì—ì„œ**ì‹œê·¸ë‹ˆì²˜ Signature**ë¼ëŠ” ê²ƒì„ ìƒì„±í•©ë‹ˆë‹¤. 
   ì´ ê°’ì€ ë©”ì‹œì§€ì˜ hash ê°’ì…ë‹ˆë‹¤. 
   KEYì™€ ë‚´ìš©ì„ HASH ì•Œê³ ë¦¬ì¦˜ì— ì ìš©í•˜ë©´, ì‹œê·¸ë‹ˆì²˜ê°€ ìƒì„±ë©ë‹ˆë‹¤.

   ì´ë ‡ê²Œ í•´ì„œ ë§Œë“  ì‹œê·¸ë‹ˆì²˜ë¥¼ ë‚´ìš©ê³¼ í•¨ê»˜ ì „ì†¡í•˜ê²Œë©ë‹ˆë‹¤. 
![](../img/2019-06-10/2.png)

3. ë°›ëŠ” ìª½ì—ì„œë„ KEYë¥¼ ì•Œê³ ìˆì£ . ê·¸ë¦¬ê³  ì•Œê³ ë¦¬ì¦˜ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤. 
   ì—¬ê¸°ì—ì„œë„ ë˜‘ê°™ì´ Signatureë¥¼ ë§Œë“¤ì–´ë´…ë‹ˆë‹¤. 
   ê·¸ë¦¬ê³  ì´ë¥¼ ë°›ì€ Signatureì™€ ë§ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.

![](../img/2019-06-10/3.png)


ì¤‘ê°„ì— ë©”ì‹œì§€ê°€ ìœ„ì¡°ë˜ì—ˆë‹¤ë©´, 
**ë³´ë‚¸ ì‹œì ì˜ ë©”ì‹œì§€ì™€ ë°›ì€ ì‹œì ì˜ ë©”ì‹œì§€ê°€ ë‹¤ë¥´ë‹ˆê¹Œ signatureë„ ë‹¤ë¥´ê²Œ ë‚˜ì˜¬ê²ƒì´ë‹¤.** 
ë¼ëŠ” ê²ƒì´ HMACì˜ ì»¨ì…‰ì…ë‹ˆë‹¤.

ë§Œì•½ signatureê¹Œì§€ ìœ„ì¡°í•˜ë ¤ê³  í•´ë„, ìœ„ì¡°ìëŠ” KEY ê°’ì„ ëª¨ë¥´ë‹ˆê¹Œ ìœ„ì¡°í•  ìˆ˜ ì—†ë‹¤ëŠ” ì ì´ ì¥ì ì…ë‹ˆë‹¤. 


### SHA256ì€ ë­”ì§€ ì„¤ëª…ì€ í•˜ê³  ê°€ë¼ ğŸ‘½

SHA- ì‹œë¦¬ì¦ˆë“¤ì€ Secure Hash Algorithm ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ, í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ì˜ ì¢…ë¥˜ë“¤ì„ ë§í•©ë‹ˆë‹¤. 
SHA-1, SHA-2 .. ë“±ì´ ìˆëŠ”ë°ìš”. ì¤‘ê°„ì— ëª¨ë“  ìˆ«ìê°€ ìˆëŠ” ê±´ ì•„ë‹™ë‹ˆë‹¤. 
SHA-2 ëŠ” ë‹¤ì´ì œìŠ¤íŠ¸ì˜ ê¸¸ì´ê°€ ë‹¤ì–‘í•œë°ìš”, ì´ ì¤‘ ë‹¤ì´ì œìŠ¤íŠ¸ì˜ ê¸¸ì´ê°€ 256byteì¸ ê²ƒì„ **SHA-256**ì´ë¼ê³  í•©ë‹ˆë‹¤. 



## ê·¸ëŸ¼ ì½”ë“œë¡œ ì–´ë–»ê²Œ ì§œìš”?

ìˆ˜ì‹ ì¸¡ ì…ì¥ì—ì„œ ì§œë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. 

ë¯¸ë¦¬ ë§ì€ ì‚¬ëŒë“¤ì´ êµ¬í˜„ì„ í•´ë‘ì—ˆê¸°ë•Œë¬¸ì— ì½”ë“œë¡œ ì˜®ê¸°ëŠ” ê²ƒì€ ê°„ë‹¨í•©ë‹ˆë‹¤. 

ì•„ë˜ì—ì„œ `verifySigature`ëŠ” ë“¤ì–´ì˜¨ signatureì™€ì˜ ë¹„êµ, 
`getHmacSignature` ì€ ì§ì ‘ signatureë¥¼ ë§Œë“œëŠ” ë©”ì†Œë“œì…ë‹ˆë‹¤. 

```java 

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;

import org.apache.commons.codec.binary.Base64;
import org.apache.commons.lang3.StringUtils;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Component
public class SignatureVerifier {
    private static final String SIGNATURE_ALGORITHM = "HmacSHA256";

    @Value("${service.secret}")
    private String secret;

    public boolean verifySignature(String signature, String requestBody) {

        if (StringUtils.isBlank(signature) || StringUtils.isBlank(requestBody)) {
            return false;
        }

        String madeSignature = getHmacSignature(requestBody.getBytes());
        log.info("Sender-sent signature: {}, made signature :{}", signature, madeSignature);

        return signature.trim().equals(madeSignature);
    }

    public String getHmacSignature(byte[] requestBody) {
        byte[] key = secret.getBytes();
        final SecretKeySpec secretKey = new SecretKeySpec(key, SIGNATURE_ALGORITHM);

        try {
            Mac mac = Mac.getInstance(SIGNATURE_ALGORITHM);
            mac.init(secretKey);
            return Base64.encodeBase64String(mac.doFinal(requestBody));
        } catch (Exception ignored) {
            log.warn("Error occured processing Mac init - Exception : {}, secretKey: {}", ignored, secretKey);
            return "";
        }

    }
}

```

ê·¸ë¦¬ê³  ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œëŠ” requestBody ì „ë¶€ë¥¼ ë°›ê¸°ìœ„í•´ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. 

```java 

 @PostMapping("/endpoint")
    public ResponseEntity receiveEvent(@RequestHeader(value = X_SIGNATURE, required = false) String signature,
                                                   @RequestBody(required = false) String json) throws IOException {

        if (!verifier.verifySignature(signature, json)) {
            log.warn("Failed To verify signature.");
            return ResponseEntity.status(BAD_REQUEST).build();
        }
        //.. ìƒëµ
        return ResponseEntity.ok().build();
    }
```


HMAC-SHA256ìœ¼ë¡œ ìœ„ë³€ì¡°ë¥¼ ê²€í† í•˜ê³ , 
ì¸ì¦ì— ì‚¬ìš©í•˜ëŠ” ê²ƒì€ í”í•œ íŒ¨í„´ì…ë‹ˆë‹¤. 

ì´ ê¸€ì„ ì°¾ìœ¼ì‹  ë¶„ë“¤ê»˜ ë„ì›€ì´ ë˜ì…¨ìœ¼ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤. 



## ì°¸ê³  

[http://blog.jakeymvc.com/sso-hmac/](http://blog.jakeymvc.com/sso-hmac/)