---
slug: "/2019-09-05/spring-security"
updated: 2020-03-09 14:21
title: Spring Security ê°œë… ì¡ê¸°
date: 2019-09-05 00:30:00 +0000
tags: 
    - Security
    - Spring
---

# Spring Security 

ì—…ë¬´ì—ì„œ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©´ì„œë„, ì‰½ê²Œ ì •ë¦¬í•˜ê¸°ëŠ” ì–´ë ¤ìš´ ê²ƒ ì¤‘ í•˜ë‚˜ê°€ spring security ì˜€ëŠ”ë°ìš”. ê°„ë‹¨í•œ ì˜ˆì œë¡œ spring securityë¥¼ ì ìš©í•  ê¸°íšŒê°€ ìˆì–´ ê°œë…ê³¼ ì˜ˆì œ ì½”ë“œë¥¼ ì •ë¦¬í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤. ì„¤ì •ì€ ë‹¤ë£¨ì§€ ì•Šìœ¼ë‹ˆ ì´ë¯¸ ìˆëŠ” ì½”ë“œë¥¼ ë³´ê³  ì´í•´ë¥¼ í•˜ì‹œë ¤ëŠ” ë¶„ë“¤ê»˜ ì¶”ì²œí•©ë‹ˆë‹¤.

## Spring Securityë€?

ì, ë‚˜ëŠ” í† ì´í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í–ˆë‹¤. ê·¸ë¦¬ê³  ì•¼ì‹¬ì°¨ê²Œ form ìœ¼ë¡œ í•˜ëŠ” ë¡œê·¸ì¸ì„ êµ¬í˜„í–ˆë‹¤. 'ìœ ì €ë‘ ë¡œê·¸ì¸ êµ¬í˜„í–ˆìœ¼ë‹ˆ í”„ë¡œì íŠ¸ ë°˜ì€ í•œê±°ì§€!'  ë¼ê³  ìƒê°í•  ë¬´ë µ, ë¹„ë¡œê·¸ì¸ ìœ ì €ì—ê²ŒëŠ” ì–´ë–¤ API ë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•˜ê²Œ í•˜ê³  ì‹¶ì–´ì¡Œë‹¤. ê·¸ë˜ì„œ Controllerì˜ ë©”ì†Œë“œ ì•ˆì— **ì¼ì¼íˆ** í˜„ì¬ ì„¸ì…˜ì„ ì²´í¬í•˜ëŠ” ì½”ë“œë¥¼ ë„£ì—ˆë‹¤. 
```java
@RestController
public SampleController {


    @GetMapping("/")
    void getMyInfo(){
        checkSession();
        // ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° í•„ìš”í•œ ì½”ë“œ 
    } 
    
    @PostMapping("/")
    void postMyInfo(){
        checkSession();
        // ì •ë³´ë¥¼ ë§Œë“œëŠ”ë° í•„ìš”í•œ ì½”ë“œ
    } 

}
```
ì¤‘ë³µë˜ëŠ” ë¶€ë¶„ì´ ìˆì§€ë§Œ, ê´œì°®ë‹¤! ë‚˜ë¦„ ë”°ë¡œ ë©”ì†Œë“œë¡œ ëºì–ì•„(`checkSession`) ^^! ë‚˜ëŠ” ë©‹ì§„ ê°œë°œì ğŸ‘½  

ğŸ¤” ê·¸ëŸ°ë°, controller ë§ˆë‹¤ ì´ê±¸ ë§¤ë²ˆ í•´ì¤˜ì•¼í•˜ë‚˜..? 

ğŸ˜¨ ë¡œê·¸ì¸ ìœ ì € ì¤‘ì—ì„œ ì–´ë“œë¯¼ ê¶Œí•œì´ ìˆëŠ” ìœ ì €ë§Œ ì‚¬ìš©í•˜ê³  ì‹¶ì€ api ëŠ” ì–´ë–¡í•˜ì§€?

ğŸ˜° ê·¸ëŸ¼ checkSessionë§ê³  checkAuthoritiesë„ ìˆì–´ì•¼í•´..?

ì ì  ê·¼ì‹¬ì´ ê¹Šì–´ì§„ë‹¤ ğŸ˜­

ì´ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” Spring securityëŠ” ìŠ¤í”„ë§ ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ë³´ì•ˆ, ì¦‰ ì¸ì¦(ë„ˆ ëˆ„êµ¬ë‹ˆ?, Authenticate) ì™€ ì¸ê°€(ë„ˆ ë­í• ìˆ˜ìˆë‹ˆ?, Authorize) ë¥¼ ë‹´ë‹¹í•˜ëŠ” í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤. Spring securityë¥¼ ì‚¬ìš©í•˜ë©´ ìœ„ì˜ ê·¼ì‹¬ê±±ì •ì„ í•œë²ˆì— ë‚ ë¦´ ìˆ˜ ìˆëŠ” ì ‘ê·¼ ë°©ì‹ê³¼ ì˜µì…˜ì„ ì œê³µí•©ë‹ˆë‹¤. 

ìœ„ì˜ ë¬¸ì œë¥¼ ìš”ì•½í•˜ë©´ ë‘ê°€ì§€ì¸ë°ìš”.

- ë§¤ ìš”ì²­ë§ˆë‹¤ ì„¸ì…˜ì„ ì§ì ‘ ê²€ì‚¬í•´ì•¼í•¨
- ë§¤ ìš”ì²­ë§ˆë‹¤ ìœ ì €ì˜ ê¶Œí•œì„ ê²€ì‚¬í•´ì•¼í•¨

Spring security ëŠ” **í•„í„°**(filter) ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ ë¶€ë¶„ì„ ê¹”ë”í•˜ê²Œ ë§ˆë¬´ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.

## êµ¬ì¡°

![](../img/2019-09-05/security-d7d6279e-abaf-4421-be75-10284bb8b98f.png)

ë¯¼íŠ¸ìƒ‰ìœ¼ë¡œ í‘œì‹œí•œ ì»´í¬ë„ŒíŠ¸ë“¤ì„ ë´ì£¼ì„¸ìš”. ì´ ì»´í¬ë„ŒíŠ¸ë“¤ì´ í•¨ê»˜ ë™ì‘í•˜ë©´ì„œ ì¸ì¦ ë¡œì§ì´ ì™„ì„±ë©ë‹ˆë‹¤. 

- ì¸ì¦ì²˜ë¦¬í•„í„°(AuthenticationProcessingFilter)
- ë§ ê·¸ëŒ€ë¡œ ìš”ì²­(HttpServletRequest)ì•ˆì—ì„œ Authenticationì„ êº¼ë‚´ëŠ” ì—­í• 
- request ì˜ cookieì— ì¸ì¦ ì •ë³´ê°€ ìˆì„ ìˆ˜ë„ ìˆê³ ,
- formì— ë‹´ê²¨ì„œ ì˜¬ ìˆ˜ë„ ìˆë‹¤.(ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸)
- ì´ê±¸ ì •ì œí•´ì„œ ë§¤ë‹ˆì €ì—ê²Œ ë„˜ê²¨ì¤ë‹ˆë‹¤ ğŸ§
- ì¸ì¦ë§¤ë‹ˆì €(AuthenticationManager)
- ì¸ì¦ë‹¨ê³„ì— ìˆì–´ì„œ, Spring securityê°€ ì£¼ ì „ëµìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì»´í¬ë„ŒíŠ¸
- ë”¸ë‘ í•˜ë‚˜ì˜ ë©”ì†Œë“œ(`authenticate`)ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.
```java
    public interface AuthenticationManager {
    
        Authentication authenticate(Authentication authentication)
        throws AuthenticationException;
    
    }
```
- inputìœ¼ë¡œ ë“¤ì–´ì˜¨ authenticationì´ ìœ íš¨í•œ principal(ë³´í˜¸ëœ ëŒ€ìƒì— ì ‘ê·¼í•˜ëŠ” ìœ ì €)ë¥¼ ëŒ€í‘œí•˜ê³  ìˆë‹¤ê³  íŒë‹¨í•˜ë©´ Authenticationì„ ë°˜í™˜í•©ë‹ˆë‹¤.
- ìœ íš¨í•˜ì§€ ì•Šì€ principalì¸ ê²½ìš°, ì—ëŸ¬ë¥¼ ë˜ì§‘ë‹ˆë‹¤.

> ê·¸ëŸ°ë°.. ì¸í„°í˜ì´ìŠ¤ì¸ë°ìš”? ğŸ¤”

- ì£¼ êµ¬í˜„ì²´ëŠ” **ProviderManager(ì‹¤ì œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë…€ì„ì€ ì´ ì¹œêµ¬!)**
- ProviderManagerëŠ” ì•„ë˜ AuthenticationProvider ë¥¼ Listë¡œ ê°€ì§‘ë‹ˆë‹¤.
- ê·¸ë¦¬ê³  ì‚¬ì‹¤ìƒ ì¼ì„ ì•„ë˜ AuthenticationProviderì— ë– ë„˜ê¹ë‹ˆë‹¤ ğŸ˜… (delegate, ìœ„ì„)
- ì¸ì¦ì œê³µì(AuthenticationProvider)
- Managerì˜ `authenticate` ë©”ì†Œë“œ +  ì£¼ì–´ì§„ authentication typeì„ ì§€ì›í•˜ëŠ”ì§€ ê²€ì‚¬í•  ìˆ˜ ìˆëŠ” ë©”ì†Œë“œê°€ í•˜ë‚˜ ë” ìˆìŠµë‹ˆë‹¤.
- ì‹¤ì œë¡œ ì¸ì¦ì´ ì¼ì–´ë‚˜ê³ , ì„±ê³µí•˜ë©´ Authentication ê°ì²´ì˜ `isAuthenticated` ë¥¼ trueë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‹ˆ ì‹¤ì œ AuthenticationManager - AuthenticationProvider ê´€ê³„ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤ âœ¨

![](../img/2019-09-05/security-2-e3e6daa3-3725-4293-89a3-d8511b0312d8.png)

ìœ„ì—ì„œ spring security ì˜ êµ¬ì¡°ë¥¼ ë³´ë©´ filterë¥¼ í†µí•´ì„œ ì‘ë™í•˜ëŠ” êµ¬ì¡°ì´ì£ . 

ì‹¤ì œë¡œ security ì„¤ì • íŒŒì¼ì„ ë³´ë©´ ì´ë ‡ìŠµë‹ˆë‹¤. 
```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    // @formatter:off
    http.antMatcher("/api/**")
        .addFilterAt(authenticationProcessingFilter(), AbstractAuthenticationProcessingFilter.class)
        .authorizeRequests()
        .antMatchers(HttpMethod.POST, "/*/user/**").permitAll()
```
`configure` ë©”ì†Œë“œì—ì„œ filter ë¥¼ ì •í•´ì¤ë‹ˆë‹¤. 

ì„¤ì •ëœ **filter**ì•ˆì—ëŠ” filterì˜ ìš”ì²­ì„ ì²˜ë¦¬í•´ì¤„ **AuthenticationManager**ê°€ ì •í•´ì ¸ìˆê³ .. 

ê·¸ Managerì˜ ì‹¤ì œ êµ¬í˜„ì²´ëŠ” **ProviderManager**ì…ë‹ˆë‹¤. 

ê·¸ ì•ˆì—ëŠ” **AuthenticationProvider**ê°€ ë¦¬ìŠ¤íŠ¸ë¡œ ì œê³µë©ë‹ˆë‹¤. 
```java
// Filterë¥¼ ë°˜í™˜
public Filter authenticationProcessingFilter() {
        CustomAuthenticatedProcessingFilter filter = new CustomAuthenticatedProcessingFilter();
        filter.setAuthenticationManager(new ProviderManager(Collections.singletonList(customAuthenticationProvider())));
        return filter;
    }

private PreAuthenticatedAuthenticationProvider customAuthenticationProvider() {
    PreAuthenticatedAuthenticationProvider provider = new PreAuthenticatedAuthenticationProvider();
    provider.setPreAuthenticatedUserDetailsService(new customUserDetailService());

    return provider;
}
```
### ì €ê¸°.. UserDetailsëŠ” ë­ê³  UserDetailServiceëŠ” ë­ì§€?

ìœ„ êµ¬ì¡°ì—ì„œ **ì¶”ê°€ì •ë³´ë¥¼ ì €ì¥ì†Œì—ì„œ ê°€ì ¸ì™€ì„œ Authenticationì— ë„£ì–´ì¤„ê²Œ!** ë¼ëŠ” ë¶€ë¶„ ê¸°ì–µí•˜ì‹¤ê¹Œìš”. 

ì—¬ê¸°ì—ì„œ ì¶”ê°€ ì •ë³´ë¼ëŠ” ê²ƒì´ UserDetails ë¼ê³  ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤. 

Authenticationì— ì¶”ê°€ì •ë³´ë¥¼ UserDetailsì˜ í˜•íƒœë¡œ, principal ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë“¤ì–´ê°€ëŠ” ê²ƒì´ì£ .
```java
public interface Authentication extends Principal, Serializable {
    
    Collection<? extends GrantedAuthority> getAuthorities();


    Object getCredentials();

    Object getDetails();

    /**
        * The identity of the principal being authenticated. In the case of an authentication
        * request with username and password, this would be the username. Callers are
        * expected to populate the principal for an authentication request.
        * <p>
        * The <tt>AuthenticationManager</tt> implementation will often return an
        * <tt>Authentication</tt> containing richer information as the principal for use by
        * the application. Many of the authentication providers will create a
        * {@code UserDetails} object as the principal.
        *
        * @return the <code>Principal</code> being authenticated or the authenticated
        * principal after authentication.
        */
// Object classê°€ UserDetailsë¥¼ ìƒì†í•œ í˜•íƒœë¡œ ì •í•  ìˆ˜ ìˆë‹¤. 
    Object getPrincipal();
```
ë‹¤ë§Œ ìœ„ì— ë‚˜ì™€ìˆëŠ” ì„¤ëª… ëŒ€ë¡œ, principalì€ ë‹¨ìˆœíˆ usernameì´ ë  ìˆ˜ë„ ìˆê³ , ë” í’ë¶€í•œ(richer) ì •ë³´ë¥¼ ë‹´ê¸° ìœ„í•´ì„œ UserDetails ë¥¼ ì„¸íŒ…í•´ì¤„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì¦‰ UserDetails ì™€ UserDetailsë¥¼ ë§Œë“¤ì–´ì„œ ë„£ì–´ì£¼ëŠ” UserDetails ServiceëŠ” ì˜µì…˜ì…ë‹ˆë‹¤. 

ê°ê°ì˜ ì˜ˆì‹œë¥¼ í•œë²ˆ ë³´ê² ìŠµë‹ˆë‹¤. 
```java
@Accessors(chain = true)
@Data
public class CustomUserDetails implements UserDetails {
    private User user;

    private Set<CustomGrantedAuthority> grantedAuthorities;

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return grantedAuthorities;
    }

    @Override
    public String getPassword() {
        return null;
    }

    @Override
    public String getUsername() {
        return null;
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}
```
UserDetailsë¥¼ ì‹¤ì œë¡œ êµ¬í˜„í•  ë•ŒëŠ” `UserDetails` ë¥¼ implement  í•´ì£¼ë©´ ë©ë‹ˆë‹¤. 
```java
@Slf4j
@Service
public class CustomUserDetailService implements AuthenticationUserDetailsService<Authentication> {

    @Override
    public UserDetails loadUserDetails(Authentication token) {
        User user = (User) token.getPrincipal();

        if (user == null) {
            throw new PreAuthenticatedCredentialsNotFoundException("USER IS NULL");
        }

                // DBì— ì ‘ê·¼í•´ì„œ ì§ì ‘ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ê²Œ ì¼ë°˜ì ì…ë‹ˆë‹¤.
    
        return new CustomUserDetails().setUser(user).setGrantedAuthorities(user.getAuthorities());
    }

}
```
ì„œë¹„ìŠ¤ë¥¼ êµ¬í˜„í•  ë•ŒëŠ” `AuthenticationUserDetailsService` ë¥¼ implementí•©ë‹ˆë‹¤. 

## ì–´ë–»ê²Œ ì“°ë‚˜ìš”?

Spring securityì˜ ì„¤ì •ì€ xml í˜¹ì€ Java Configurationìœ¼ë¡œë„ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” í›„ìë¡œ ì§„í–‰í•©ë‹ˆë‹¤. 

ì €ëŠ” SecurityConfigë¼ëŠ” ì´ë¦„ì˜ `@Configuration` ì„ ë§Œë“¤ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” WebSecurityConfigurerAdapterë¥¼ ìƒì†í•©ë‹ˆë‹¤. ì´ í´ë˜ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `configure`  ë©”ì†Œë“œë¥¼ êµ¬í˜„í•˜ê²Œ ë˜ì–´ìˆë„¤ìš”. 
```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    // @formatter:off
    http.antMatcher("/api/**")
        .addFilterAt(authenticationProcessingFilter(), AbstractAuthenticationProcessingFilter.class)
        .authorizeRequests()
        .antMatchers(HttpMethod.POST, "/*/user/**").permitAll()
```
ì´ì œ ì´ ì•„ë˜ì— antMatchersë¡œ í•´ë‹¹í•˜ëŠ” uriì™€, ì›í•˜ëŠ” ì•¡ì…˜ì„ ì„¤ì •í•´ì£¼ë©´ ë©ë‹ˆë‹¤. 

- hasRole(Role) : í•´ë‹¹ Role ì„ ê°–ê³ ìˆëŠ” ìœ ì €ì¸ ê²½ìš° í—ˆìš©
- anonymous : ìµëª… ì‚¬ìš©ì (ì¦‰ ì¸ì¦ì´ ì•ˆëœ ì‚¬ìš©ì) í—ˆìš©
- authenticated : ì¸ì¦ëœ ì‚¬ìš©ì í—ˆìš©
- permitAll : ëª¨ë“  ì‚¬ìš©ì í—ˆìš©
- denyAll : ëª¨ë“  ì‚¬ìš©ìê°€ ì‚¬ìš© ë¶ˆê°€

## ê²°ë¡ 

ì¼ë‹¨ ì‚¬ìš©í•˜ëŠ” ë²”ìœ„ë‚´ì—ì„œ Spring securityë¥¼ ì •ë¦¬í•´ë³´ì•˜ëŠ”ë°ìš”. ì´ì •ë„ë©´ ê¸°ì¡´ì— êµ¬í˜„ëœ ì½”ë“œë¥¼ ì´í•´í•˜ê¸°ì—ëŠ” ì¶©ë¶„í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤. 
ì˜ëª»ëœ ê²ƒì´ ìˆìœ¼ë©´ ì—´ë¦° ë§ˆìŒìœ¼ë¡œ í”¼ë“œë°± ë¶€íƒë“œë¦½ë‹ˆë‹¤.


---

ì°¸ê³ 

[https://spring.io/guides/topicals/spring-security-architecture](https://spring.io/guides/topicals/spring-security-architecture)

[https://sjh836.tistory.com/165](https://sjh836.tistory.com/165)